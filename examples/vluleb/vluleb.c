#include <rvintrin.h>
#include <assert.h>
#include <string.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>

static inline long rdinstret() { int64_t rd; asm volatile ("rdinstret %0" : "=r"(rd) : : "memory"); return rd; }

#define NUM 896

uint64_t din[NUM] = {
	// for k in {1..14}; do for i in {1..64}; do echo $i | sha1sum; done | sed -r "s/(.{$k}).*/0x\1,/"; done | gawk '{printf"%s%c",$0,NR%4?" ":"\n";}'
	0xe, 0x7, 0xa, 0x9,
	0x5, 0xc, 0xd, 0x1,
	0xb, 0x4, 0xd, 0xa,
	0xf, 0x0, 0x5, 0x3,
	0xa, 0x2, 0xb, 0xd,
	0x8, 0xa, 0xa, 0xb,
	0xc, 0xa, 0x9, 0x2,
	0xc, 0x9, 0x2, 0x6,
	0x3, 0xe, 0x4, 0x5,
	0x0, 0x6, 0xe, 0xb,
	0x0, 0x3, 0x2, 0xf,
	0xa, 0x8, 0x5, 0xf,
	0x4, 0x1, 0x1, 0xb,
	0xb, 0x2, 0x4, 0xf,
	0x8, 0x7, 0x3, 0xb,
	0xd, 0xa, 0x0, 0x7,
	0xe5, 0x74, 0xa3, 0x9c,
	0x5d, 0xcc, 0xd3, 0x13,
	0xb6, 0x41, 0xdd, 0xad,
	0xfe, 0x03, 0x58, 0x35,
	0xad, 0x24, 0xba, 0xd0,
	0x8e, 0xa6, 0xae, 0xb3,
	0xc6, 0xa0, 0x9c, 0x29,
	0xc6, 0x97, 0x22, 0x69,
	0x37, 0xee, 0x45, 0x5b,
	0x02, 0x66, 0xe6, 0xb0,
	0x05, 0x34, 0x23, 0xf5,
	0xa0, 0x80, 0x5d, 0xf7,
	0x4c, 0x1f, 0x1f, 0xb5,
	0xb8, 0x2d, 0x48, 0xff,
	0x83, 0x77, 0x38, 0xb4,
	0xd5, 0xa4, 0x05, 0x78,
	0xe5f, 0x744, 0xa3d, 0x9c6,
	0x5d9, 0xccf, 0xd39, 0x136,
	0xb6a, 0x414, 0xdd7, 0xad5,
	0xfee, 0x030, 0x587, 0x359,
	0xad4, 0x24b, 0xba9, 0xd07,
	0x8ee, 0xa66, 0xaec, 0xb31,
	0xc6e, 0xa03, 0x9c7, 0x295,
	0xc61, 0x97e, 0x229, 0x693,
	0x37e, 0xeee, 0x45c, 0x5bf,
	0x02e, 0x664, 0xe6f, 0xb0e,
	0x05d, 0x349, 0x23e, 0xf54,
	0xa06, 0x803, 0x5de, 0xf75,
	0x4c8, 0x1fb, 0x1f3, 0xb57,
	0xb81, 0x2de, 0x488, 0xffb,
	0x834, 0x773, 0x389, 0xb42,
	0xd51, 0xa4d, 0x052, 0x783,
	0xe5fa, 0x7448, 0xa3db, 0x9c6b,
	0x5d94, 0xccf2, 0xd396, 0x1365,
	0xb6ab, 0x4143, 0xdd71, 0xad55,
	0xfeee, 0x0305, 0x587b, 0x3596,
	0xad48, 0x24b9, 0xba9f, 0xd075,
	0x8eec, 0xa66c, 0xaec4, 0xb319,
	0xc6e4, 0xa036, 0x9c7b, 0x2958,
	0xc611, 0x97ea, 0x2298, 0x6934,
	0x37e3, 0xeeec, 0x45c2, 0x5bf6,
	0x02ed, 0x6643, 0xe6fd, 0xb0ee,
	0x05df, 0x3497, 0x23e1, 0xf54e,
	0xa06b, 0x8031, 0x5de1, 0xf752,
	0x4c80, 0x1fb4, 0x1f33, 0xb572,
	0xb811, 0x2deb, 0x4888, 0xffb8,
	0x8349, 0x7734, 0x389e, 0xb429,
	0xd514, 0xa4d3, 0x052d, 0x7838,
	0xe5fa4, 0x7448d, 0xa3db5, 0x9c6b0,
	0x5d947, 0xccf27, 0xd3964, 0x13657,
	0xb6abd, 0x4143d, 0xdd710, 0xad552,
	0xfeee4, 0x03051, 0x587b5, 0x3596e,
	0xad481, 0x24b9c, 0xba9f3, 0xd0758,
	0x8eecb, 0xa66ca, 0xaec46, 0xb3199,
	0xc6e4f, 0xa0361, 0x9c7ba, 0x29581,
	0xc6112, 0x97ea7, 0x22980, 0x69340,
	0x37e3e, 0xeeec0, 0x45c20, 0x5bf6e,
	0x02ede, 0x6643b, 0xe6fdd, 0xb0ee9,
	0x05df0, 0x34973, 0x23e18, 0xf54ee,
	0xa06b1, 0x8031f, 0x5de16, 0xf7520,
	0x4c80a, 0x1fb45, 0x1f33b, 0xb5728,
	0xb8117, 0x2debe, 0x48889, 0xffb80,
	0x83497, 0x77347, 0x389e4, 0xb4297,
	0xd5145, 0xa4d3c, 0x052da, 0x7838b,
	0xe5fa44, 0x7448d8, 0xa3db5c, 0x9c6b05,
	0x5d9474, 0xccf271, 0xd3964f, 0x136571,
	0xb6abd5, 0x4143d3, 0xdd7103, 0xad552e,
	0xfeee44, 0x030514, 0x587b59, 0x3596ea,
	0xad4810, 0x24b9c1, 0xba9f37, 0xd07585,
	0x8eecbb, 0xa66ca4, 0xaec46d, 0xb31990,
	0xc6e4ff, 0xa0361d, 0x9c7ba4, 0x29581e,
	0xc6112f, 0x97ea7e, 0x22980f, 0x693406,
	0x37e3ec, 0xeeec02, 0x45c20f, 0x5bf6e5,
	0x02ede1, 0x6643b1, 0xe6fdd8, 0xb0ee9c,
	0x05df01, 0x349732, 0x23e182, 0xf54ee8,
	0xa06b1e, 0x8031fa, 0x5de163, 0xf75209,
	0x4c80a2, 0x1fb45e, 0x1f33b8, 0xb5728b,
	0xb81179, 0x2debea, 0x488892, 0xffb80d,
	0x834977, 0x77347f, 0x389e4c, 0xb4297d,
	0xd51456, 0xa4d3c7, 0x052da9, 0x7838b9,
	0xe5fa44f, 0x7448d87, 0xa3db5c1, 0x9c6b057,
	0x5d9474c, 0xccf271b, 0xd3964f9, 0x136571b,
	0xb6abd56, 0x4143d3a, 0xdd71038, 0xad552e6,
	0xfeee44a, 0x030514d, 0x587b596, 0x3596ea0,
	0xad48103, 0x24b9c1f, 0xba9f376, 0xd075856,
	0x8eecbb7, 0xa66ca42, 0xaec46dc, 0xb31990e,
	0xc6e4ffd, 0xa0361d5, 0x9c7ba4b, 0x29581e4,
	0xc6112fc, 0x97ea7ec, 0x22980f6, 0x6934061,
	0x37e3ecf, 0xeeec021, 0x45c20f2, 0x5bf6e53,
	0x02ede1e, 0x6643b1a, 0xe6fdd81, 0xb0ee9cc,
	0x05df01e, 0x3497327, 0x23e1825, 0xf54ee8e,
	0xa06b1ef, 0x8031fac, 0x5de163e, 0xf752092,
	0x4c80a26, 0x1fb45e0, 0x1f33b84, 0xb5728b4,
	0xb811797, 0x2debea0, 0x4888920, 0xffb80d1,
	0x8349778, 0x77347fb, 0x389e4cc, 0xb4297d8,
	0xd514562, 0xa4d3c74, 0x052da91, 0x7838b90,
	0xe5fa44f2, 0x7448d879, 0xa3db5c13, 0x9c6b057a,
	0x5d9474c0, 0xccf271b7, 0xd3964f9d, 0x136571b4,
	0xb6abd567, 0x4143d3a3, 0xdd71038f, 0xad552e6d,
	0xfeee44ad, 0x030514d8, 0x587b596f, 0x3596ea08,
	0xad48103e, 0x24b9c1f3, 0xba9f376f, 0xd0758565,
	0x8eecbb71, 0xa66ca429, 0xaec46dc0, 0xb31990ee,
	0xc6e4ffdb, 0xa0361d50, 0x9c7ba4b1, 0x29581e41,
	0xc6112fc2, 0x97ea7ec8, 0x22980f6c, 0x69340613,
	0x37e3ecf5, 0xeeec0218, 0x45c20f21, 0x5bf6e535,
	0x02ede1ee, 0x6643b1a6, 0xe6fdd81a, 0xb0ee9cc6,
	0x05df01e3, 0x34973274, 0x23e18250, 0xf54ee8e7,
	0xa06b1ef9, 0x8031facf, 0x5de163e1, 0xf7520925,
	0x4c80a26e, 0x1fb45e0b, 0x1f33b849, 0xb5728b43,
	0xb811797a, 0x2debea01, 0x4888920a, 0xffb80d10,
	0x8349778b, 0x77347fb3, 0x389e4ccf, 0xb4297d8b,
	0xd514562e, 0xa4d3c742, 0x052da912, 0x7838b900,
	0xe5fa44f2b, 0x7448d8798, 0xa3db5c13f, 0x9c6b057a2,
	0x5d9474c03, 0xccf271b78, 0xd3964f9da, 0x136571b41,
	0xb6abd567f, 0x4143d3a34, 0xdd71038f3, 0xad552e6dc,
	0xfeee44ad3, 0x030514d80, 0x587b596f0, 0x3596ea087,
	0xad48103e4, 0x24b9c1f3f, 0xba9f376fa, 0xd0758565f,
	0x8eecbb71d, 0xa66ca4290, 0xaec46dc0d, 0xb31990eea,
	0xc6e4ffdb7, 0xa0361d509, 0x9c7ba4b16, 0x29581e412,
	0xc6112fc24, 0x97ea7ec8a, 0x22980f6cd, 0x69340613d,
	0x37e3ecf5f, 0xeeec02189, 0x45c20f214, 0x5bf6e5357,
	0x02ede1eec, 0x6643b1a6b, 0xe6fdd81a2, 0xb0ee9cc6b,
	0x05df01e32, 0x34973274c, 0x23e182506, 0xf54ee8e79,
	0xa06b1ef93, 0x8031facf4, 0x5de163e1f, 0xf75209253,
	0x4c80a26e3, 0x1fb45e0b8, 0x1f33b8494, 0xb5728b43a,
	0xb811797a0, 0x2debea01a, 0x4888920a5, 0xffb80d10e,
	0x8349778b6, 0x77347fb35, 0x389e4ccf1, 0xb4297d8ba,
	0xd514562e9, 0xa4d3c7422, 0x052da9125, 0x7838b9004,
	0xe5fa44f2b3, 0x7448d8798a, 0xa3db5c13ff, 0x9c6b057a2b,
	0x5d9474c030, 0xccf271b783, 0xd3964f9dad, 0x136571b41a,
	0xb6abd567fa, 0x4143d3a341, 0xdd71038f34, 0xad552e6dc0,
	0xfeee44ad36, 0x030514d808, 0x587b596f04, 0x3596ea087b,
	0xad48103e4f, 0x24b9c1f3fd, 0xba9f376fa7, 0xd0758565fd,
	0x8eecbb71d4, 0xa66ca4290e, 0xaec46dc0de, 0xb31990eea1,
	0xc6e4ffdb7e, 0xa0361d509d, 0x9c7ba4b168, 0x29581e412c,
	0xc6112fc247, 0x97ea7ec8a6, 0x22980f6cd0, 0x69340613d8,
	0x37e3ecf5f4, 0xeeec021898, 0x45c20f2147, 0x5bf6e5357b,
	0x02ede1eec1, 0x6643b1a6b8, 0xe6fdd81a2e, 0xb0ee9cc6bd,
	0x05df01e327, 0x34973274cc, 0x23e182506f, 0xf54ee8e79b,
	0xa06b1ef93d, 0x8031facf4b, 0x5de163e1f7, 0xf752092537,
	0x4c80a26e33, 0x1fb45e0b8e, 0x1f33b8494a, 0xb5728b43aa,
	0xb811797a04, 0x2debea01ac, 0x4888920a56, 0xffb80d10ea,
	0x8349778b6c, 0x77347fb359, 0x389e4ccf12, 0xb4297d8ba7,
	0xd514562e9d, 0xa4d3c74229, 0x052da9125c, 0x7838b9004b,
	0xe5fa44f2b31, 0x7448d8798a4, 0xa3db5c13ff9, 0x9c6b057a2b9,
	0x5d9474c0309, 0xccf271b7830, 0xd3964f9dad9, 0x136571b41aa,
	0xb6abd567fa7, 0x4143d3a3418, 0xdd71038f346, 0xad552e6dc05,
	0xfeee44ad365, 0x030514d8086, 0x587b596f04f, 0x3596ea087bf,
	0xad48103e4fc, 0x24b9c1f3fdd, 0xba9f376fa71, 0xd0758565fd0,
	0x8eecbb71d41, 0xa66ca4290eb, 0xaec46dc0de4, 0xb31990eea1c,
	0xc6e4ffdb7e1, 0xa0361d509d7, 0x9c7ba4b1689, 0x29581e412c0,
	0xc6112fc2472, 0x97ea7ec8a6b, 0x22980f6cd08, 0x69340613d82,
	0x37e3ecf5f46, 0xeeec021898e, 0x45c20f2147e, 0x5bf6e5357bd,
	0x02ede1eec13, 0x6643b1a6b88, 0xe6fdd81a2e7, 0xb0ee9cc6bd7,
	0x05df01e3270, 0x34973274cce, 0x23e182506f4, 0xf54ee8e79ba,
	0xa06b1ef93d7, 0x8031facf4b2, 0x5de163e1f74, 0xf7520925375,
	0x4c80a26e33c, 0x1fb45e0b8e8, 0x1f33b8494a3, 0xb5728b43aa3,
	0xb811797a045, 0x2debea01ac5, 0x4888920a568, 0xffb80d10ea8,
	0x8349778b6c4, 0x77347fb3594, 0x389e4ccf123, 0xb4297d8ba77,
	0xd514562e9d3, 0xa4d3c742290, 0x052da9125cb, 0x7838b9004b4,
	0xe5fa44f2b31c, 0x7448d8798a43, 0xa3db5c13ff90, 0x9c6b057a2b9d,
	0x5d9474c0309b, 0xccf271b78308, 0xd3964f9dad9f, 0x136571b41aa1,
	0xb6abd567fa79, 0x4143d3a34187, 0xdd71038f3463, 0xad552e6dc057,
	0xfeee44ad365b, 0x030514d80869, 0x587b596f04f7, 0x3596ea087bfd,
	0xad48103e4fc7, 0x24b9c1f3fddf, 0xba9f376fa719, 0xd0758565fd06,
	0x8eecbb71d418, 0xa66ca4290eba, 0xaec46dc0de48, 0xb31990eea1ce,
	0xc6e4ffdb7e1f, 0xa0361d509d71, 0x9c7ba4b1689f, 0x29581e412c09,
	0xc6112fc24727, 0x97ea7ec8a6bb, 0x22980f6cd080, 0x69340613d824,
	0x37e3ecf5f468, 0xeeec021898ee, 0x45c20f2147e0, 0x5bf6e5357bd4,
	0x02ede1eec131, 0x6643b1a6b884, 0xe6fdd81a2e7a, 0xb0ee9cc6bd7c,
	0x05df01e32704, 0x34973274ccef, 0x23e182506f4b, 0xf54ee8e79bad,
	0xa06b1ef93d78, 0x8031facf4b26, 0x5de163e1f743, 0xf75209253756,
	0x4c80a26e33c2, 0x1fb45e0b8e83, 0x1f33b8494a3d, 0xb5728b43aa39,
	0xb811797a045f, 0x2debea01ac55, 0x4888920a568a, 0xffb80d10ea87,
	0x8349778b6c45, 0x77347fb35940, 0x389e4ccf1237, 0xb4297d8ba77b,
	0xd514562e9d3e, 0xa4d3c742290b, 0x052da9125cb1, 0x7838b9004b44,
	0xe5fa44f2b31c1, 0x7448d8798a438, 0xa3db5c13ff90a, 0x9c6b057a2b9d9,
	0x5d9474c0309b7, 0xccf271b783088, 0xd3964f9dad9f6, 0x136571b41aa14,
	0xb6abd567fa79c, 0x4143d3a341877, 0xdd71038f3463f, 0xad552e6dc057d,
	0xfeee44ad365b6, 0x030514d808697, 0x587b596f04f7d, 0x3596ea087bfda,
	0xad48103e4fc71, 0x24b9c1f3fddff, 0xba9f376fa7190, 0xd0758565fd06c,
	0x8eecbb71d418e, 0xa66ca4290ebaf, 0xaec46dc0de48f, 0xb31990eea1cee,
	0xc6e4ffdb7e1f4, 0xa0361d509d714, 0x9c7ba4b1689f7, 0x29581e412c098,
	0xc6112fc247276, 0x97ea7ec8a6bb8, 0x22980f6cd0807, 0x69340613d824d,
	0x37e3ecf5f468d, 0xeeec021898eec, 0x45c20f2147e03, 0x5bf6e5357bd42,
	0x02ede1eec131f, 0x6643b1a6b884e, 0xe6fdd81a2e7ae, 0xb0ee9cc6bd7c6,
	0x05df01e327042, 0x34973274ccef6, 0x23e182506f4b8, 0xf54ee8e79bad1,
	0xa06b1ef93d78f, 0x8031facf4b264, 0x5de163e1f7435, 0xf75209253756e,
	0x4c80a26e33c28, 0x1fb45e0b8e830, 0x1f33b8494a3d4, 0xb5728b43aa396,
	0xb811797a045f4, 0x2debea01ac55a, 0x4888920a568af, 0xffb80d10ea87a,
	0x8349778b6c457, 0x77347fb359409, 0x389e4ccf12377, 0xb4297d8ba77b0,
	0xd514562e9d3e1, 0xa4d3c742290b2, 0x052da9125cb1b, 0x7838b9004b44d,
	0xe5fa44f2b31c1f, 0x7448d8798a4380, 0xa3db5c13ff90a3, 0x9c6b057a2b9d96,
	0x5d9474c0309b7c, 0xccf271b7830882, 0xd3964f9dad9f60, 0x136571b41aa14a,
	0xb6abd567fa79cb, 0x4143d3a3418771, 0xdd71038f3463f5, 0xad552e6dc057d1,
	0xfeee44ad365b6b, 0x030514d8086974, 0x587b596f04f7db, 0x3596ea087bfdaf,
	0xad48103e4fc717, 0x24b9c1f3fddff7, 0xba9f376fa71904, 0xd0758565fd06c3,
	0x8eecbb71d418ef, 0xa66ca4290ebaf5, 0xaec46dc0de48f3, 0xb31990eea1cee9,
	0xc6e4ffdb7e1f4c, 0xa0361d509d714f, 0x9c7ba4b1689f7c, 0x29581e412c0981,
	0xc6112fc247276d, 0x97ea7ec8a6bb8a, 0x22980f6cd0807e, 0x69340613d824dc,
	0x37e3ecf5f468d8, 0xeeec021898eec1, 0x45c20f2147e030, 0x5bf6e5357bd42a,
	0x02ede1eec131f8, 0x6643b1a6b884eb, 0xe6fdd81a2e7aee, 0xb0ee9cc6bd7c60,
	0x05df01e3270426, 0x34973274ccef6a, 0x23e182506f4b88, 0xf54ee8e79bad1e,
	0xa06b1ef93d78fd, 0x8031facf4b264d, 0x5de163e1f74357, 0xf75209253756ec,
	0x4c80a26e33c288, 0x1fb45e0b8e830a, 0x1f33b8494a3d4e, 0xb5728b43aa396c,
	0xb811797a045f45, 0x2debea01ac55a6, 0x4888920a568af4, 0xffb80d10ea87ad,
	0x8349778b6c4574, 0x77347fb359409b, 0x389e4ccf123777, 0xb4297d8ba77b0d,
	0xd514562e9d3e15, 0xa4d3c742290b20, 0x052da9125cb1b6, 0x7838b9004b44d6,
};

uint64_t dout_uvlu56_encode_reference[NUM];
uint64_t dout_uvlu56_encode_bitmanip[NUM];

uint64_t dout_uvlu56_decode_reference[NUM];
uint64_t dout_uvlu56_decode_bitmanip[NUM];

uint64_t dout_leb128_encode_reference[NUM];
uint64_t dout_leb128_encode_bitmanip[NUM];

uint64_t dout_leb128_decode_reference[NUM];
uint64_t dout_leb128_decode_bitmanip[NUM];

// libgcc __builtin_clzll implementation
extern int __clzdi2 (unsigned long);

// libgcc __builtin_ctzll implementation
extern int __ctzdi2 (unsigned long);

// based on https://github.com/michaeljclark/vlu#encoder-c
uint64_t uvlu56_encode_reference(uint64_t num)
{
	if (!num) return 0;
	int lz = __clzdi2(num);
	int t1 = 8 - ((lz - 1) / 7);
	int shamt = t1 + 1;
	return (num << shamt) | ((1 << (shamt - 1)) - 1);
}

uint64_t uvlu56_encode_bitmanip(uint64_t num)
{
	long shamt = (_rv64_clz(num) - 70) / -7;
	return ((num << shamt) | _rv64_slo(0, shamt-1)) & _rv64_orc(num);
}

// based on https://github.com/michaeljclark/vlu#decoder-c
uint64_t uvlu56_decode_reference(uint64_t uvlu)
{
	int t1 = __ctzdi2(~uvlu);
	int shamt = t1 + 1;
	uint64_t mask = shamt == 8 ? -(uint64_t)1 : ~(-(uint64_t)1 << (shamt << 3));
	uint64_t data = (uvlu & mask) >> shamt;
	return data;
}

uint64_t uvlu56_decode_bitmanip(uint64_t uvlu)
{
	long shamt = _rv64_ctz(uvlu + 1) + 1;
	return (uvlu >> shamt) & _rv64_slo(0, (shamt << 3)-shamt);
}

// based on https://en.wikipedia.org/wiki/LEB128#Encode_unsigned_integer
uint64_t leb128_encode_reference(uint64_t in)
{
	uint64_t out = in & 127;
	long shamt = 7;
	in >>= 7;

	while (in) {
		out |= (uint64_t)1 << shamt;
		out |= (uint64_t)(in & 127) << (shamt+1);
		shamt += 8;
		in >>= 7;
	}

	return out;
}

uint64_t leb128_encode_bitmanip(uint64_t in)
{
	uint64_t mask = _rv64_orc8(0x80);
	uint64_t out = _rv64_bdep(in, ~mask);
	uint64_t t = (((uint64_t)!out)-1) >> (_rv64_clz(out) & 63);
	return out | (mask & t);
}

// based on https://en.wikipedia.org/wiki/LEB128#Decode_unsigned_integer
uint64_t leb128_decode_reference(uint64_t in)
{
	uint64_t out = in & 127;
	long shamt = 7;

	while (in & 128) {
		in >>= 8;
		out |= (in & 127) << shamt;
		shamt += 7;
	}

	return out;
}

uint64_t leb128_decode_bitmanip(uint64_t in)
{
	uint64_t mask = _rv64_orc8(0x80);
	long t = (_rv64_ctz(~_rv64_bext(in, mask)) << 3) + 7;
	return _rv64_bext(in & _rv64_slo(0, t), ~mask);
}

#define TEST(_name, _iter, _code) \
  do { \
    printf("testing %s..\n", #_name); \
    long icnt = rdinstret(); \
    _code \
    icnt = rdinstret() - icnt; \
    p += sprintf(p, "%-25s %5ld instructions  (%2.1f inst / dword)\n", #_name, icnt, (float)icnt / _iter); \
  } while (0)

int main()
{
	char buffer[16*1024];
	char *p = buffer;

	TEST(uvlu56_encode_reference, NUM, {
		for (int i = 0; i < NUM; i++) {
			dout_uvlu56_encode_reference[i] = uvlu56_encode_reference(din[i]);
			// printf("  %3d: 0x%016lx -> 0x%016lx\n", i, din[i], dout_uvlu56_encode_reference[i]);
		}
	});

	TEST(uvlu56_encode_bitmanip, NUM, {
		for (int i = 0; i < NUM; i++) {
			dout_uvlu56_encode_bitmanip[i] = uvlu56_encode_bitmanip(din[i]);
			// printf("  %3d: 0x%016lx -> 0x%016lx\n", i, din[i], dout_uvlu56_encode_bitmanip[i]);
		}
	});

	p += sprintf(p, "\n");

	assert(!memcmp(dout_uvlu56_encode_reference, dout_uvlu56_encode_bitmanip, sizeof(din)));

	TEST(uvlu56_decode_reference, NUM, {
		for (int i = 0; i < NUM; i++) {
			dout_uvlu56_decode_reference[i] = uvlu56_decode_reference(dout_uvlu56_encode_reference[i]);
			// printf("  %3d: 0x%016lx -> 0x%016lx\n", i, dout_uvlu56_encode_reference[i], dout_uvlu56_decode_reference[i]);
		}
	});

	assert(!memcmp(din, dout_uvlu56_decode_reference, sizeof(din)));

	TEST(uvlu56_decode_bitmanip, NUM, {
		for (int i = 0; i < NUM; i++) {
			dout_uvlu56_decode_bitmanip[i] = uvlu56_decode_bitmanip(dout_uvlu56_encode_bitmanip[i]);
			// printf("  %3d: 0x%016lx -> 0x%016lx\n", i, dout_uvlu56_encode_bitmanip[i], dout_uvlu56_decode_bitmanip[i]);
		}
	});

	assert(!memcmp(dout_uvlu56_decode_reference, dout_uvlu56_decode_bitmanip, sizeof(din)));

	p += sprintf(p, "\n");

	TEST(leb128_encode_reference, NUM, {
		for (int i = 0; i < NUM; i++) {
			dout_leb128_encode_reference[i] = leb128_encode_reference(din[i]);
			// printf("  %3d: 0x%016lx -> 0x%016lx\n", i, din[i], dout_leb128_encode_reference[i]);
		}
	});

	TEST(leb128_encode_bitmanip, NUM, {
		for (int i = 0; i < NUM; i++) {
			dout_leb128_encode_bitmanip[i] = leb128_encode_bitmanip(din[i]);
			// printf("  %3d: 0x%016lx -> 0x%016lx\n", i, din[i], dout_leb128_encode_bitmanip[i]);
		}
	});

	p += sprintf(p, "\n");

	assert(!memcmp(dout_leb128_encode_reference, dout_leb128_encode_bitmanip, sizeof(din)));

	TEST(leb128_decode_reference, NUM, {
		for (int i = 0; i < NUM; i++) {
			dout_leb128_decode_reference[i] = leb128_decode_reference(dout_leb128_encode_reference[i]);
			// printf("  %3d: 0x%016lx -> 0x%016lx\n", i, dout_leb128_encode_reference[i], dout_leb128_decode_reference[i]);
		}
	});

	assert(!memcmp(din, dout_leb128_decode_reference, sizeof(din)));

	TEST(leb128_decode_bitmanip, NUM, {
		for (int i = 0; i < NUM; i++) {
			dout_leb128_decode_bitmanip[i] = leb128_decode_bitmanip(dout_leb128_encode_bitmanip[i]);
			// printf("  %3d: 0x%016lx -> 0x%016lx\n", i, dout_leb128_encode_bitmanip[i], dout_leb128_decode_bitmanip[i]);
		}
	});

	assert(!memcmp(dout_leb128_decode_reference, dout_leb128_decode_bitmanip, sizeof(din)));

	printf("\n%s\n", buffer);

	return 0;
}
